<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>建立任务管理数据页面</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
<!--    <link rel="stylesheet" href="layui/css/layui.css" media="all" />-->
    <link rel="stylesheet" href="../plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="../css/public.css" media="all" />
    <script type="text/javascript" src="../js/jquery-2.0.3.js"></script>
    <script src="../js/jquery.cookie.min.js"></script>

    <link rel="stylesheet" href="../css/bootstrap.css" media="all" />
    <link rel="stylesheet" href="../css/message.css" media="all" />
    <script src="../js/message.js"></script>



    <script src="../js/ipconfig.js"></script>
    <script type="text/javascript" src="../js/requestParamData.js"></script>
    <!--    自动更新会话时间-->
    <script src="../js/autoupdate.js"></script>

<!--    <script type="text/javascript">-->
<!--        var mybck= $.cookie('tokenMyb');-->
<!--        //alert(document.cookie);-->
<!--        //console.log(mybck)-->
<!--        if(mybck == "" || mybck == null){-->
<!--            window.location.href="login.html";-->

<!--        }else{-->
<!--            //console.log("进来");-->
<!--            //parent.location.reload(); //刷新父页面-->
<!--            window.location.href="mainWxesh.html";-->
<!--        }-->


<!--    </script>-->

    <style>
        /*.layui-form-switch {*/
        /*    position: relative;*/
        /*    height: 22px;*/
        /*    line-height: 22px;*/
        /*    min-width: 35px;*/
        /*    padding: 0 5px;*/
        /*    margin-top: 8px;*/
        /*    border: 1px solid #d2d2d2;*/
        /*    border-radius: 20px;*/
        /*    cursor: pointer;*/
        /*    background-color: #fff;*/
        /*    -webkit-transition: .1s linear;*/
        /*    transition: .1s linear;*/
        /*}*/

    </style>

</head>
<body class="childrenBody">
<div class="layui-fluid" >
    <blockquote class="layui-elem-quote"><p class="layui-green" style="font-size:14px;color: #008B8B;" >温馨提醒:当前访问的是建立任务数据</p></blockquote>
    <form class="layui-form" action="">
        <!--<br/>-->
        <div class="layui-form-item layui-form-pane">


            <div class="layui-inline" style="margin-top:20px;">
                <label class="layui-form-label" style="width: 145px;">任务名字:</label>
                <div class="layui-input-inline" style="width: 165px;">
                    <input type="text" id="tasK_name_input" name="tasK_name_input" autocomplete="off" class="layui-input">
                </div>
            </div>
<!--            <div class="layui-inline" style="margin-top:20px;">-->
<!--                <label class="layui-form-label" style="width: 95px;">时间:</label>-->
<!--                <div class="layui-input-inline" style="width: 185px;">-->
<!--                    <input type="text" class="layui-input" name="start_time" id="test5">-->
<!--                </div>-->
<!--                <div class="layui-form-mid">-</div>-->
<!--                <div class="layui-input-inline" style="width: 185px;">-->
<!--                    <input type="text" class="layui-input" name="end_time" id="test6">-->
<!--                </div>-->
<!--            </div>-->

            <div class="layui-inline" style="margin-top:20px;">
                <label class="layui-form-label" style="width: 130px;">任务状态:</label>
                <div class="layui-input-inline" style="width: 165px;">
                    <select type="text" id="task_status" name="task_status" autocomplete="off" class="layui-select">
<!--                        <option value="" selected>请选择</option>-->
                        <option value="1" selected>未完成</option>
                        <option value="2">完成</option>
                        <option value="3">已删除</option>
                    </select>
                </div>
            </div>


<!--            <div class="layui-inline" style="margin-top:20px;">-->
<!--                <label class="layui-form-label" style="width: 130px;">拉群状态:</label>-->
<!--                <div class="layui-input-inline" style="width: 165px;">-->
<!--                    <select type="text" id="lq_status" name="lq_status" autocomplete="off" class="layui-select">-->
<!--                        <option value="" selected>请选择</option>-->
<!--                        <option value="没有权限">没有权限</option>-->
<!--                        <option value="未接任务">未接任务</option>-->
<!--                        <option value="已接任务">已接任务</option>-->
<!--                    </select>-->
<!--                </div>-->
<!--            </div>-->

            <div class="layui-inline" style="margin-top:20px;">
                <div class="layui-btn " data-type="reload"><i class="layui-icon"></i>查询</div>
                <div id="reloadtable" class="layui-btn layui-bg-cyan"><i class="layui-icon">ဂ</i>刷新数据</div>
<!--                <div id="reloadpage" class="layui-btn layui-btn-normal"><i class="layui-icon">ဂ</i>刷新页面</div>-->
            </div>
        </div>
    </form>
    <div style="padding-bottom: 10px;">
        <!--        <button class="layui-btn layuiadmin-btn-useradmin" data-type="batchdel">删除</button>-->
<!--        <button class="layui-btn layui-btn-lg" data-type="add" lay-submit="" lay-filter="addInfoS">批量删除</button>-->
        <button class="layui-btn layui-btn-lg" data-type="addTask" lay-submit="" lay-filter="addInfoS" id="addTask">新建任务</button>
    </div>
    <table id="merchantOrderT" lay-filter="logs" ></table>


<!--    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">-->
<!--        <legend>倒计时</legend>-->
<!--    </fieldset>-->
<!--    请选择要计算的日期：-->
<!--    <div class="layui-inline">-->
<!--        <input type="text" class="layui-input" id="test1" value="2099-01-01 00:00:00">-->
<!--    </div>-->




</div>
<!--操作-->
<script type="text/html" id="orderListBar">
    <button class="layui-btn layui-btn-xs layui-btn-normal id_uploadScan" lay-event="uploadScan" ><i class="layui-icon">&#xe619;</i>上传二维码</button>

<!--    {{# if(d.qr_code_url  != "" && d.qr_code_url != "null" && d.qr_code_url != null){ }}-->
<!--      <button class="layui-btn layui-btn-xs layui-btn-normal id_uploadScan" lay-event="uploadScan"><i class="layui-icon" >&#xe619;</i>上传二维码</button>-->
<!--    {{# } else{ }}-->
<!--      <button class="layui-btn layui-btn-xs layui-btn-normal id_uploadScan" lay-event="uploadScan" ><i class="layui-icon">&#xe619;</i>上传二维码</button>-->
<!--    {{# } }}-->


    <button class="layui-btn layui-btn-xs " lay-event="edit"><i class="layui-icon">&#xe642;</i>修改</button>
    <button class="layui-btn layui-btn-xs layui-btn-primary" lay-event="look"><i class="layui-icon">&#xe615;</i>详情</button>

<!--    普通写法-->
<!--    <button class="layui-btn layui-btn-xs layui-btn-warm" lay-event="configInfo"><i class="layui-icon">&#xe6c6;</i>配置</button>-->

<!--    layui-btn layui-btn-disabled-->

<!--    另种写法-->
    {{# if(d.switch == 1){ }}
     <button class="layui-btn layui-btn-xs layui-btn-warm" lay-event="configInfo"><i class="layui-icon">&#xe6c6;</i>配置</button>
    {{# } else{ }}
     <button class="layui-btn layui-btn-xs layui-btn-disabled" lay-event="configInfo" disabled="disabled"><i class="layui-icon">&#xe6c6;</i>配置</button>
    {{# } }}

    <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete"><i class="layui-icon">&#xe640;</i>删除</button>
</script>

<script type="text/javascript" src="../layui/layui.js"></script>

<script>

    var mybck= $.cookie('tokenMyb');
    //alert(document.cookie);
    //console.log(mybck)
    if(mybck == "" || mybck == null){
        // window.location.href="login.html";

        layer.alert('当前会话已过期，请重新登录！', {
            skin: 'layui-layer-molv',//样式类名
            shadeClose: true,
            shade: 0.8
            ,closeBtn: 0
        }, function(){

            window.top.location.href= "../"+js_again_login;

        });
    }else{
        //console.log("进来");
        //parent.location.reload(); //刷新父页面
        // window.location.href="mainWxesh.html";

        // //所有请求地址通过本地json全局获取
        // var gdImg = "";
        // var gdrequestUrl="";
        // var gdrequestWxwshUrl = "";
        // var gdrequestchangeStatus="";
        //
        // $.getJSON("json/config.json", function(data) {
        //
        //     gdImg = data.global_imgAddress;    //获取审核图片地址
        //     gdrequestUrl = data.global_requestUrl;  //获取请求地址前缀
        //     gdrequestWxwshUrl = data.global_requestWxwshUrl  //获取审核完整请求地址
        //     gdrequestchangeStatus =  data.global_change_wx_statusUrl
        //     // console.log("未通过微信："+gdrequestWxwshUrl);
        //
        // });


        // 加载需要用到的模块，如果有使用到自定义模块也在此加载
        layui.use(['laydate','form','table','upload'], function(){
            var orderLoadingIndex = layer.load(0); //添加laoding,0-2两种方式
            // 初始化元素，如果有大量的元素操作可以也引入和初始化element模块
            var table = layui.table;
            var form = layui.form;
            var laydate = layui.laydate;
            var upload = layui.upload;
            var $ = layui.$;
            // // 定义时间选择器
            // laydate.render({
            //     elem:'#test5',
            //     type:'datetime'
            // });
            // laydate.render({
            //     elem:'#test6',
            //     type:'datetime'
            // });

            // var requestData = wxglRequest($.cookie('tokenMyb'),2,2,1);

            //订单表
            var tableIns = table.render({
                elem: '#merchantOrderT',
                // url:'wtgsh.json',
                url : js_change_get_group_tasks+"?token="+$.cookie('tokenMyb')+"&status=1",
                // method: 'post',
                // where:requestData,
                // where:{token: $.cookie('tokenMyb'),status:2,addFans_status:2,add_group_status:1},//当前访问的是审核未通过的数据
                cellMinWidth : 95,
                page :  { //支持传入 laypage 组件的所有参数（某些参数除外，如：jump/elem） - 详见文档
                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                    //,curr: 5 //设定初始在第 5 页
                    ,groups: 10 //只显示 1 个连续页码
                    ,first: "首页" //不显示首页
                    ,last: "尾页"//不显示尾页
                },
                height : "full-20",
                limit : 15,
                limits : [15,30,50,100],
                id : "systemLog",
                cols : [[
                    {type: "checkbox", fixed:"left", width:50},
                    // {field: 'id', title: '编号', width:60, align:"center"},
                    // {field: 'xid', title: '编号', width:60, align:"center",templet: '#titleTpl'},
                    {field: 'id', title: 'ID', minWidth:'60',sort: true, width:'60', type:'space',align:"center"},//, style :'display: none'
                    {field: 'name', title: '任务名字', sort: true,width:150, align:'center'},

                    // {field: 'wx_number', title: '微信号码',sort: true, width:180, align:'center'},
                    // {field: 'wx_tag', title: '微信标签', sort: true,width:180, align:'center'},

                    {field: 'qr_code_url', title: '加群二维码',sort: true,width:200, height:100, align:'center',templet: function(d){


                        // console.log(d.qr_code_url);

                        if(d.qr_code_url == "" || d.qr_code_url == null || d.qr_code_url == "null"){

                            return '<button class="layui-btn layui-btn-danger layui-btn-xs" >'+'未上传'+'</button>'

                        }else{

                            return '<button class="layui-btn layui-bg-blue  layui-btn-xs">'+'已上传'+'</button>'
                            // var imageName = js_global_imgAddress+d.qr_code_url;
                            // // console.log(d.qr_code_url.length);
                            // if(d.qr_code_url.length == 39){
                            //
                            //     return '<div onclick="showImg(this)" ><img src="'+imageName+'" ' + 'alt="" width="200px" height="60px"></a></div>';
                            // }else {
                            //
                            //     imageName= js_global_imgAddress+imageName.substr(imageName.length-39);
                            //
                            //     // return imageName;
                            //
                            //     return '<div onclick="showImg(this)" ><img src="'+imageName+'" ' + 'alt="" width="200px" height="60px"></a></div>';
                            //
                            // }


                        }

                    }},
                    // {field: 'imager_url', title: '审核截图URL', width:360, align:'center'},////默认显示URL地址
                    {field: 'status', title: '任务状态',sort: true,width:110, align:'center',templet:function(d){
                            if (d.status == "1") {

                                return '<button class="layui-btn layui-btn-warm  layui-btn-xs">'+'未完成'+'</button>'

                            }else if (d.status == "2") {

                                return '<button class="layui-btn layui-bg-green  layui-btn-xs">'+'完成'+'</button>'
                            }else if (d.status == "3") {

                                return '<button class="layui-btn layui-bg-red  layui-btn-xs">'+'已删除'+'</button>'

                            }


                    }},
                    {field: 'switch', title: '任务开关',sort: true,width: 150, align: 'center', templet: function (d) {
                            var state = "";

                            // state = "<input type='checkbox' value='" + d.status + "' id='status' lay-filter='status'  name='status'  lay-skin='switch' lay-text='开启|关闭' >";

                            // if (d.switch == "1") {
                            //  state = "<input type='checkbox' value='" + d.switch + "' id='status' lay-filter='status' checked='checked' name='status'  lay-skin='switch' lay-text='开启|关闭' >";
                            // } else {
                            //  state = "<input type='checkbox' value='" + d.switch + "' id='status' lay-filter='status'  name='status'  lay-skin='switch' lay-text='开启|关闭' >";
                            //
                            // }
                            //
                            // return state;

                            if (d.switch == "1") {
                                return '<button class="layui-btn layui-bg-green  layui-btn-xs">'+'已开启'+'</button>'
                                // state = "<span>"+'已开启'+"</span>";
                                // state = "<input type='checkbox' value='" + d.id + "' id='status' lay-filter='status' checked='checked' name='status'  lay-skin='switch' lay-text='开启|关闭' >";
                            } else {
                                state = "<input type='checkbox' value='" + d.id + "' id='status' lay-filter='status'  name='status'  lay-skin='switch' lay-text='开启|关闭' >";

                            }
                            return state;
                        }
                    },
                    {field: 'task_number', title: '任务编号',sort: true, width:200, align:'center'},
                    {field: 'task_object', title: '任务目标个数',sort: true, width:150, align:'center'},
                    {field: 'done_nums', title: '已完成目标个数',sort: true, width:150, align:'center'},
                    //用layer自带的转换方法没有效果,暂时用网上JS封装的工具类
                    {field: 'created_at', title: '创建时间', sort: true,width: 270, align:'center',templet: function (d) {
                            var unixTimestamp = new Date(d.created_at * 1000)
                            return formatDateTime(unixTimestamp)
                        }},
                    {field: 'updated_at', title: '更新时间',sort: true,width:270, align:'center',templet: function (d) {
                            var unixTimestamp = new Date(d.updated_at * 1000)
                            return formatDateTime(unixTimestamp)
                        }},
                    // {field: 'order_time',title: '订单时间', width:163,align:"center"},
                    // {field: 'order_time',title: '订单时间', width:118,align:"center",templet:function(d){
                    //         var to = d.order_time.substr(5,);
                    //         return to
                    //     }},
                    {title: '操作', width:400, templet:'#orderListBar',fixed:"right",align:"center"}

                ]],
                done: function(res, curr, count){
                    // $('.layui-table-cell').css({'height':'auto'});  ////暂时不用显示完整,有个小问题,把高度设置后全选按钮显示不对齐.
                    layer.close(orderLoadingIndex);    //返回数据关闭loading
                    hoverOpenImg();

                }
            });



            //新建按钮点击事件
            $("#addTask").click(function(){

                // alert("1324")
                var index = layui.layer.open({
                    area: ['800px', '250px'],
                    // area : ['100%', '100%'],
                    fixed: false, //不固定
                    maxmin: true,
                    title : "新建任务",
                    skin: 'layui-layer-rim',//加上边框
                    type : 2,
                    content : "Add_task.html",
                    success : function(layero, index){


                    }
                })

            })




            //监听禁用开关按钮操作
            form.on('switch(status)', function(obj){


                // 获取当前控件
                var selectIfKey=obj.othis;
                // 获取当前所在行
                var parentTr = selectIfKey.parents("tr");
                // 获取当前所在行的索引
                // var parentTrIndex = parentTr.attr("data-index");


                //通过相对位置找对应行数据
                // 获取当前行第一和三列的值
                var currentIds = parentTr.find(('td:eq(1)')).text().trim();

                var currentSwitch = parentTr.find(('td:eq(5)')).text().trim();
                //获取开关私聊按钮对应值
                var currenwx_checkstatus = obj.elem.checked;

                currenwx_checkstatus = (currenwx_checkstatus) ? 1:0;


                // var currentwx_number = parentTr.find(('td:eq(3)')).text().trim();

                layer.confirm('系统将对任务进行开启操作,确定当前任务开启吗?', {
                    icon:2,
                    title:'温馨提示',
                    skin: 'layui-layer-lan',
                    btn: ['确认','取消'] //按钮
                    ,cancel: function(index, layero){
                        //取消操作，点击右上角的X
                    }
                }, function(){//是
                    //进行ajax请求
                    var param={};

                    param = wxglBuildSwitchRequest($.cookie('tokenMyb'),'switch',currentIds,currenwx_checkstatus);

                    // param['token']= $.cookie('tokenMyb');
                    // param['status']= '1';
                    // param['remark']= $("#remark").val();
                    // param['wx_number']= currentwx_number;
                    // param['id']= currentwx_id;
                    // param['user_id']= currentuser_id;


                    $.post(js_change_get_group_tasks, param,
                        function(lookResult){

                            if(lookResult.code === 200 ){

                                $.message({
                                    message:lookResult.msg ,
                                    type: 'success',
                                    showClose: true
                                });


                                tableIns.reload();
                                layer.close(layer.index);


                            }else{

                                $.message({
                                    message:lookResult.msg ,
                                    type: 'error',
                                    showClose: true
                                });

                                tableIns.reload();
                                layer.close(layer.index);

                            }


                        });



                }, function(){//否

                    $.message({
                        message: "取消操作",
                        type: 'info',
                        showClose: true
                    });

                    var x = obj.elem.checked;

                    obj.elem.checked = !x;
                    form.render();
                    layer.close(layer.index);

                    // layer.alert('编辑行：<br>'+ JSON.stringify(newdata))
                });



            });



            //鼠标移动到图片,预览当前图片
            function hoverOpenImg(){
                var img_show = null; // tips提示
                $('td img').hover(function(){
                    var kd=$(this).width();
                    kd1=kd*3;          //图片放大倍数
                    kd2=kd*3+30;       //图片放大倍数
                    var img = "<img class='img_msg' src='"+$(this).attr('src')+"' style='width:"+kd1+"px;' />";
                    img_show = layer.tips(img, this,{
                        tips:[2, 'rgba(41,41,41,.5)']
                        ,area: [kd2+'px']
                    });
                },function(){
                    layer.close(img_show);
                });
                $('td img').attr('style','max-width:70px;display:block!important');
            }

            //时间戳转日期时间型工具类
            function formatDateTime(inputTime) {
                var date = new Date(inputTime);
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                m = m < 10 ? ('0' + m) : m;
                var d = date.getDate();
                d = d < 10 ? ('0' + d) : d;
                var h = date.getHours();
                h = h < 10 ? ('0' + h) : h;
                var minute = date.getMinutes();
                var second = date.getSeconds();
                minute = minute < 10 ? ('0' + minute) : minute;
                second = second < 10 ? ('0' + second) : second;
                return y + '-' + m + '-' + d+' '+h+':'+minute+':'+second;
            }

           //监听工具条
            //列表操作
            table.on('tool(logs)', function(obj){
                var layEvent = obj.event; //获得 lay-event 对应的值
                var newdata = obj.data; //获得当前行数据
                var newtr = obj.tr; //获得当前行tr的DOM对象

                if(layEvent === 'look'){ //详情


                    var index = layui.layer.open({
                        area: ['600px', '550px'],
                        // area : ['100%', '100%'],
                        fixed: false, //不固定
                        maxmin: true,
                        title : "当前任务详情信息",
                        skin: 'layui-layer-rim',//加上边框
                        type : 2,
                        content : "Build_task_details.html",
                        success : function(layero, index){

                            var body = layui.layer.getChildFrame('body', index);

                            if(newdata) {

                                //不显示出来的回显数据
                                body.find("#sub_task_object_detail").val(newdata.task_object);
                                body.find("#sub_done_nums_detail").val(newdata.done_nums);
                                body.find("#sub_qr_code_url_detail").val(newdata.qr_code_url);



                                body.find("#sub_id_detail").html(newdata.id);
                                body.find("#sub_name_detail").html(newdata.name);
                                body.find("#sub_access_nums_detail").html(newdata.access_nums);
                                body.find("#sub_submit_nums_detail").html(newdata.submit_nums);
                                body.find("#recall_times").html(newdata.recall_times);




                                //回显已撤回数据
                                // body.find("#sub_submit_nums_detail").html(newdata.submit_nums);]





                                //开关转换转换文本
                                var status_str = "";
                                newdata.status == 1 ? status_str = "任务已开启" : status_str="任务未开启"
                                body.find("#sub_status_detail").html(status_str);

                                body.find("#sub_task_number_detail").html(newdata.task_number);

                                //日期时间转换转换文本
                                var time_created_at = formatDateTime(new Date(newdata.created_at * 1000));
                                // console.log(time_created_at);
                                var time_updated_at = formatDateTime(new Date(newdata.updated_at * 1000));

                                //配置点击转换文本
                                var config_click_str = "";
                                newdata.config_click == 1 ? config_click_str = "已配置" : config_click_str="尚未配置"


                                body.find("#sub_config_click_detail").html(config_click_str);
                                body.find("#sub_created_at_detail").html(time_created_at);
                                body.find("#sub_updated_at_detail").html(time_updated_at);



                                setTimeout(function(){
                                    layui.layer.tips('点击此处返回创建任务页面', '.layui-layer-setwin .layui-layer-close', {
                                        tips: 3
                                    });
                                },500)
                            }
                        }
                    })


                    // layui.layer.full(index);
                    window.sessionStorage.setItem("index",index);
                    //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                    $(window).on("resize",function(){
                        layui.layer.full(window.sessionStorage.getItem("index"));
                    })



                }else if(layEvent === 'edit'){ //编辑



                    var index = layui.layer.open({
                        area: ['800px', '250px'],
                        // area : ['100%', '100%'],
                        fixed: false, //不固定
                        maxmin: true,
                        title : "编辑任务",
                        skin: 'layui-layer-rim',//加上边框
                        type : 2,
                        content : "Edit_task.html",
                        success : function(layero, index){

                            var body = layui.layer.getChildFrame('body', index);
                            if(newdata) {
                                body.find("#task_id").val(newdata.id);
                                body.find("#task_name").val(newdata.name);
                                body.find("#task_object").val(newdata.task_object);

                                setTimeout(function(){
                                    layui.layer.tips('点击此处返回创建任务页面', '.layui-layer-setwin .layui-layer-close', {
                                        tips: 3
                                    });
                                },500)
                            }
                        }
                    })


                    // layui.layer.full(index);
                    window.sessionStorage.setItem("index",index);
                    //改变窗口大小时，重置弹窗的宽高，防止超出可视区域（如F12调出debug的操作）
                    $(window).on("resize",function(){
                        layui.layer.full(window.sessionStorage.getItem("index"));
                    })


                }else if(layEvent === 'uploadScan'){//上传二维码

                    var index = layui.layer.open({
                        area: ['600px', '600px'],
                        // area : ['100%', '100%'],
                        fixed: false, //不固定
                        maxmin: true,
                        title : "上传群二维码",
                        skin: 'layui-layer-rim',//加上边框
                        type : 2,
                        content : "Upload_task_img.html"+"?queryid="+newdata.id,
                        success : function(layero, index){

                            var body = layui.layer.getChildFrame('body', index);
                            if(newdata) {

                                // var tmpQrcode =  newdata.qr_code_url;
                                //
                                // if(tmpQrcode == "未上传"){
                                //
                                //
                                // }


                                // js_global_img = "";
                                // js_global_img = newdata.qr_code_url;


                                // $("#sub_task_qr_code_url").val(newdata.qr_code_url);

                                // console.log("未弹窗前:"+newdata.qr_code_url);
                                body.find("#sub_task_qr_code_url").val(newdata.qr_code_url);
                                setTimeout(function(){
                                    layui.layer.tips('点击此处返回创建任务页面', '.layui-layer-setwin .layui-layer-close', {
                                        tips: 3
                                    });
                                },500)
                            }


                        },
                        cancel: function(){
                            // 右上角关闭事件的逻辑

                            window.location.reload()

                        }

                    })





                }else if(layEvent === 'configInfo'){//配置图片次数


                    var tempUrls = newdata.qr_code_url;
                    // var tempClickTime = newdata.config_click;


                    if(tempUrls != "" && tempUrls != "null" && tempUrls != null){


                        var index = layui.layer.open({
                            area: ['400px', '600px'],
                            fixed: false, //不固定
                            maxmin: true,
                            title : "配置二维码次数",
                            skin: 'layui-layer-rim',//加上边框
                            type : 2,
                            content : "Set_times_task_img.html"+"?queryid="+newdata.id,
                            success : function(layero, index){

                                var body = layui.layer.getChildFrame('body', index);
                                if(newdata) {

                                    body.find("#sub_task_qr_code_url").val(newdata.qr_code_url);
                                    setTimeout(function(){
                                        layui.layer.tips('点击此处返回创建任务页面', '.layui-layer-setwin .layui-layer-close', {
                                            tips: 3
                                        });
                                    },500)
                                }


                            },
                            cancel: function(){
                                // 右上角关闭事件的逻辑

                                window.location.reload()

                            }
                        })

                        //已经弃用
                        // if(tempClickTime == 0){
                        //
                        //
                        //
                        // }else{
                        //
                        //     // layer.msg("当前任务已经进行配置提交,无法再次提交!")
                        //     // layer.msg("当前任务已经进行配置提交,无法再次提交!",{icon:4});
                        // }


                    }else{

                        layer.msg("服务器未查询到二维码图片,无法配置次数,请上传二维码图片再操作")
                        // layer.msg("服务器未查询到二维码图片,无法配置次数,请上传二维码图片再操作",{icon:3})
                        // tableIns.reload();
                        // layer.close(layer.index);

                    }





                }else if(layEvent === 'delete'){ //删除

                    // layer.msg(newdata.id);

                    layer.confirm('系统将删除当前任务数据，确认要删除？', {
                        icon:2,
                        title:'温馨提示',
                        skin: 'layui-layer-lan',
                        btn: ['确认','取消'] //按钮
                        ,cancel: function(index, layero){
                            //取消操作，点击右上角的X
                        }
                    }, function(){//是

                        var statusStr = newdata.status;

                        if(statusStr == "未完成"){

                            statusStr = 1;

                        }else if(statusStr == "完成"){

                            statusStr = 2;

                        }else if(statusStr == "已删除"){


                            statusStr = 3;
                        }


                        var requestData = wxglBuildDeteleRequest($.cookie('tokenMyb'),"delete",newdata.id,statusStr);


                        $.ajax({

                            url: js_change_get_group_tasks,
                            data: requestData,
                            type: "POST",
                            dataType: "json",
                            success: function (resultJson) {

                                if (200 === resultJson.code) {



                                        $.message({
                                            message:resultJson.msg ,
                                            type: 'success',
                                            showClose: true
                                        });
                                        // layer.msg(result.msg);

                                        tableIns.reload();
                                        layer.close(layer.index);


                                }else{


                                    $.message({
                                        message:resultJson.msg ,
                                        type: 'error',
                                        showClose: true
                                    });

                                    tableIns.reload();
                                    layer.close(layer.index);

                                    // layer.msg(resultJson.msg);
                                    //alert(resultJson.code);

                                }


                            },


                        });




                    }, function(){//否

                        // layer.alert('编辑行：<br>'+ JSON.stringify(newdata))
                    });
                }
            });

            // 数据表重载，这个是配合上面的表格一起使用的
            var active = {
                reload:function(){
                    var demoReload = $('#demoReload');
                    //执行重载
                    table.reload('systemLog', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        }
                        ,where: {
                            status: $("#task_status option:selected").val(),
                            // orderstartime: $("input[name='start_time']").val(),
                            // orderendtime: $("input[name='end_time']").val()
                        }
                    });
                }
            };

            // form.render(); // 渲染表单

            // 查找点击时间，这里的事件绑定建议使用on来绑定,因为元素都是后期渲染过的
            // $("#fuck-btn").click(function(){
            //     var type = $(this).data('type');
            //     active[type] ? active[type].call(this) : '';
            // });

            $('.layui-btn').on('click', function(){
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });

            $("#reloadtable").on('click', function(){
                active.reload();
            });


            $("#reloadpage").on('click', function(){
                location.reload();
            });


        });



        //数据表格图片点击按比例缩放方法
        function showImg(imgData){
            var img = new Image();
            // img.src = imgData.attr("src");
            var ta = $(imgData).find("img");
            img.src = ta.attr("src");
            var height = img.height; // 原图片大小
            var width = img.width; //原图片大小

            var winHeight = $(window).height() - 80;  // 浏览器可视部分高度
            var winWidth = $(window).width() - 100;  // 浏览器可视部分宽度

            // 如果图片高度或者宽度大于限定的高度或者宽度则进行等比例尺寸压缩
            if (height > winHeight || width > winWidth) {
                // 1.原图片宽高比例 大于等于 图片框宽高比例
                if (winWidth/ winHeight <= width / height) {
                    width = winWidth;   //以框的宽度为标准
                    height = winWidth * (height / width);
                }

                // 2.原图片宽高比例 小于 图片框宽高比例
                if (winWidth/ winHeight > width / height) {
                    width = winHeight  * (width / height);
                    height = winHeight  ;   //以框的高度为标准
                }
            }

            var imgHtml = "<img src='" + img.src + "' width='" + width + "px' height='" + height + "px' />";
            //弹出层
            layer.open({
                type: 1,
                shade: 0.8,
                offset: 'auto',
                // area: [500 + 'px',550+'px'],
                area: [width + 'px',(height + 50) + 'px'],  //原图显示,高度+50是为了去除掉滚动条
                shadeClose:true,
                scrollbar: false,
                title: "当前审核图片预览", //不显示标题
                content: imgHtml, //捕获的元素，注意：最好该指定的元素要存放在body最外层，否则可能被其它的相对元素所影响
                cancel: function () {
                    //layer.msg('捕获就是从页面已经存在的元素上，包裹layer的结构', { time: 5000, icon: 6 });
                }
            });
        }


        ////数据表格图标点击放大效果方法
        // function show_img(t) {
        //     var ta = $(t).find("img");
        //
        //     //页面层
        //     layer.open({
        //         type: 1,
        //         title: '当前审核图片',
        //         skin: 'layui-layer-rim', //加上边框
        //         area: ['50%', '50%'], //宽高 t.width() t.height()
        //         shadeClose: true, //开启遮罩关闭
        //         end: function (index, layero) {
        //             return false;
        //         },
        //         content: '<div style="text-align:center"><img src="' + $(ta).attr('src') + '" /></div>'
        //     })
        // }


    }



</script>
<script type="text/html" id="titleTpl">
    <a style="color:gray;"  class="layui-table-link">{{d.LAY_TABLE_INDEX+1}}</a>
</script>

</body>
</html>

